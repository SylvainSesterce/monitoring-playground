---
- name: Configure VMs
  hosts: all
  roles:
    - packages
  tasks:
    - name: Install local ssh key
      ansible.posix.authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ lookup('file', '/home/tassadar/.ssh/framework.pub') }}"

- name: Deploy mimir
  hosts: mimir
  become: true
  tasks:
    - name: Deploy minio on docker
      community.docker.docker_container:
        name: minio-mimir
        ports:
          - 9000:9000
          - 9001:9001
        networks:
          - name: molecule
        env:
          MINIO_ROOT_USER: "testtest"
          MINIO_ROOT_PASSWORD: "testtest"
          MINIO_DEFAULT_BUCKETS: "mimir"
        image: bitnami/minio:latest
    - name: Install mimir
      ansible.builtin.include_role:
        name: grafana.grafana.mimir
      vars:
        # Run against minio blob store backed, see readme for local setup or mimir docs for Azure,   AWS, etc.
        mimir_storage:
          storage:
            backend: s3
            s3:
              endpoint: localhost:9000
              access_key_id: testtest
              secret_access_key: testtest
              insecure: true
              bucket_name: mimir

        # Blocks storage requires a prefix when using a common object storage bucket.
        mimir_blocks_storage:
          storage_prefix: blocks
          tsdb:
            dir: "{{ mimir_working_path}}/ingester"

        # Use memberlist, a gossip-based protocol, to enable the 3 Mimir replicas to communicate
        mimir_memberlist:
          join_members:
            - mimir1:7946
            - mimir2:7946
            - mimir3:7946
